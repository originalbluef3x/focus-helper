<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap');

        * {
            color: white;
            font-family: "Outfit", sans-serif;
            font-weight: 400;
            margin: 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        *::-webkit-scrollbar {
            display: none;
        }

        /* ===== Page Centering ===== */
        body {
            width: 100vw;
            height: 100vh;
            background-color: #343131;
            display: flex;
            align-items: center;
            /* vertical center */
            justify-content: center;
            /* horizontal center */
        }

        /* ===== Header ===== */
        .header {
            position: absolute;
            top: 0;
            right: 0;
            padding: 10px;
        }

        /* ===== Main Wrapper ===== */
        .main {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ===== Card Layout ===== */
        .card {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
        }

        .inner {
            display: flex;
            flex-direction: column;
            gap: .25rem;
        }

        /* ===== Upper Section ===== */
        .upper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: .25rem;
            width: 100%;
        }

        .title {
            font-size: 36px;
        }

        /* ===== Form ===== */
        form {
            width: 100%;
        }

        .inline {
            display: flex;
            gap: .5rem;
            width: 100%;
        }

        input {
            flex: 1;
            padding: 5px;
            border-radius: 5px;
            border: none;
            background-color: #393c3f;
            color: white !important;
        }

        button {
            padding: 5px 10px;
            border-radius: 5px;
            border: none;
            background-color: #393c3f;
            cursor: pointer;
        }

        /* ===== Content ===== */
        .container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
        }

        .text {
            display: flex;
            flex-direction: column;
            gap: .4rem;
            width: 100%;
            text-align: left;
        }

        .updateElements {
            display: flex;
            flex-direction: column;
            gap: .3rem;
        }

        /* ===== Small Text ===== */
        .upper p {
            font-size: 14px;
        }
    </style>
</head>

<body>
    <div class="header">
        <button id="showButton" onclick="show()">Toggle Text</button>
    </div>
    <div class="main">
        <div class="card">
            <div class="inner">
                <div class="upper">
                    <h1 class="title">Focus Helper</h1>
                    <form class="inline">
                        <input id="url">
                        <button type="submit">Go</button>
                    </form>
                </div>
                <div class="container"></div>

                <div class="text">
                    <p>Free distractions by launching a new pop-up window and entering fullscreen</p>
                    <p>Once pop-up opens, use F11 to open full screen, same to close.</p>
                    <div class="updateElements">
                        <p id="version">Version: </p>
                        <p id="message"></p>
                        <p id="update-link">If theres a new update, click <a href="https://github.com/originalbluef3x/focus-helper/releases">here</a> to download the latest update</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</body>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        for (let page of document.getElementsByTagName("p")) {
            page.style.display = "none";
        }
    })
    function show() {

        for (let page of document.getElementsByTagName("p")) {

            page.style.display = (page.style.display == "none" ? "inline-block" : "none");
        }
        // document.getElementById("showButton").style.display ? "" : "none";

    }
    let version = "1.2.7"
    let versionText = document.getElementById('version')
    let messageText = document.getElementById('message')
    let updatelink = document.getElementById("update-link")
    versionText.innerText += " " + version;
    try {
        messageText.innerText = "Checking for updates..."
        fetch("https://raw.githubusercontent.com/originalbluef3x/versions/refs/heads/main/versions.json", {
            method: "GET"
        })
            .then((response) => response.json())
            .then((response) => {
                let projectName = "focusHelper"
                const desc = "Focus Helper aims to limit distractions by opening pages in a new popup window preventing outside searches or url changes. For best effects, after page opens enter fullscreen."
                let thisVersion = Number(version.replaceAll(".", ""))
                let thisResponse = response[projectName]?.["version"] || false
                if (!thisResponse) return messageText.innerText = "No version type found..."
                let newestVersion = Number(thisResponse.replaceAll(".", ""))
                if (newestVersion > thisVersion) {
                    messageText.innerText = `A new update is available, version ${thisResponse}`

                    messageText.style.display = "inline-block"
                    versionText.style.display = "inline-block"
                    updatelink.style.display = "inline-block"
                } else {
                    messageText.innerText = "Up-to-date!"
                }
            })

    } catch {
        messageText.innerText = "Cannot fetch newest version..."
    }
    let params = {
        width: 1920,
        height: 1080,
        left: 100,
        top: 100,
        resizable: "yes",
        scrollbars: "yes",
        popup: true,
    }
    let searchEngines = [
        {
            "name": "google",
            "scheme": "https://google.com/search?q="
        },
        {
            "name": "duckduckgo",
            "scheme": "https://duckduckgo.com/?q="
        }
    ]
    let preferrences = {
        "searchEngine": "google"
    }
    let thisSearchEngine = function () { return searchEngines.find(e => e.name == preferrences.searchEngine.toLowerCase()); }
    // let paramsString = 'width=1920,height=1080,left=100,top=100,resizable=yes,scrollbars=yes,popup=true'
    let paramsString = "";
    function generateParams() {
        paramsString = ""
        for (objec of Object.keys(params)) {
            const replaceQuotes = params[objec].toString().replaceAll("\"", "")
            paramsString += `${objec}=${replaceQuotes},`
        }
    }

    generateParams()

    const backupListLinks = [
        "example.com",
        "google.com",
        "bing.com",
        "yahoo.com",
        "duckduckgo.com"
    ]

    const backupListQueries = [
        "google",
        "bing",
        "yahoo",
        "duckduckgo"
    ]
    const getProhibitedLinksOrDomains = async function () {
        try {
            const response = await fetch(
                "https://raw.githubusercontent.com/originalbluef3x/focus-helper/refs/heads/main/blockedLinks.json",
                { method: "GET" }
            );
            return await response.json();
        } catch (e) {
            return Array.from(backupListLinks);
        }
    };


    const getConfig = async function () {
        try {
            await fetch("https://raw.githubusercontent.com/originalbluef3x/focus-helper/refs/heads/main/config.json", {
                method: "GET"
            })
                .then((response) => response.json())
                .then((response) => {
                    return JSON.parse(response)
                })
        } catch {
            return false;
        }
    }

    const getTemperature = async function () {
        let config = getConfig();
        return Number(config["temperature"]) || false;
    }

    const getProhibitedQueriesOrEnteries = async function () {
        try {
            const response = await fetch(
                "https://raw.githubusercontent.com/originalbluef3x/focus-helper/refs/heads/main/blockedQueries.json",
                { method: "GET" }
            );
            const data = await response.json();
            return Array.from(data || backupListQueries);
        } catch (e) {
            console.error("theres an error", e);
            return Array.from(backupListQueries);
        }
    };

    let result = 0;
    const levenshteinDistance = function (s1a, s2) {

        let s1b = s1a.split(" ");
        if (s1a == s2) {
            result += -100000;
        }
        // let s2 = s2a.filter(v => v !== s1a);
        for (const s1 of s1b) {
            // If either string is empty, the distance is the length of the other string
            if (s1.length === 0) return s2.length;
            if (s2.length === 0) return s1.length;

            // Create a 2D array (matrix) to store the distances between all prefixes
            const matrix = [];

            // Initialize the first column of each row
            for (let i = 0; i <= s2.length; i++) {
                matrix[i] = [i];
            }

            // Initialize the first row
            for (let j = 0; j <= s1.length; j++) {
                matrix[0][j] = j;
            }

            // Fill in the rest of the matrix using dynamic programming
            for (let i = 1; i <= s2.length; i++) {
                for (let j = 1; j <= s1.length; j++) {
                    // Calculate the cost of substitution (0 if characters are the same, 1 otherwise)
                    const substitutionCost = s1[j - 1] === s2[i - 1] ? 0 : 1;

                    // The current cell's value is the minimum of deletion, insertion, or substitution costs
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1, // Deletion
                        matrix[i][j - 1] + 1, // Insertion
                        matrix[i - 1][j - 1] + substitutionCost // Substitution
                    );
                }
            }

            // The bottom-right cell contains the final Levenshtein distance
            const resultForThis = ((matrix[s2.length][s1.length]) / (s2.length + s1.length))
            console.log(resultForThis, matrix)
            result += resultForThis;
        }
        let s1seperate = s1a.split("")
        result = Math.round(result / s1seperate.length * 100, 2);
        console.log(s1a, result)
        return result;
    };

    const checkSearch = async function (input) {
        const temperature = await getTemperature() || .3 // 
        const tld = /^[a-z0-9-]+(\.[a-z0-9-]+)*\.[a-z]{2,}$/;
        let isTLD = tld.test(input);
        let isLinkRegex = /\w+:\/\//;
        let isLink = isLinkRegex.test(input)

        if (isTLD || isLink) {
            let latestList = await getProhibitedLinksOrDomains();
            console.log(latestList)
            if (!Array(latestList) || latestList.length <= 0) return false;
            let URLinput = !isTLD && isLink ? new URL(input).host : input;
            if (latestList.includes(URLinput)) {
                return false;
            } else {
                return input;
            }
        } else {
            let latestList = await getProhibitedQueriesOrEnteries();
            console.log(latestList)
            if (latestList.length <= 0) return false;
            const matches = latestList.filter(v => input == v ? true : ((levenshteinDistance(input, v) < (temperature * 10) ? true : false)))
            console.log(matches)
            if (matches.length > 0) {
                return false;
            } else {
                return input;
            }
        }



    }
    document.addEventListener("submit", async function (e) {
        e.preventDefault()
        let input = document.getElementById('url').value
        const tld = /^[a-z0-9-]+(\.[a-z0-9-]+)*\.[a-z]{3,}$/;
        let test = tld.test(input);
        let isLinkRegex = /\w+:\/\//;
        let isLink = function () { return isLinkRegex.test(input) }
        input = await checkSearch(input)
        if (!input.startsWith('https://') && test) {
            input = "https://" + input;
        } else if (!isLink() && !test) {
            input = thisSearchEngine().scheme + encodeURIComponent(input)
        } else if (isLink()) {
            // do nothing
        }

        window.open(input, "Window", paramsString)
    })
</script>

</html>
